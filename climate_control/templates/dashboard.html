<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Control Dashboard</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #cce5ff, #f8f9fa);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        h1 {
            color: #004085;
            font-size: 2em;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #666;
            font-size: 0.9em;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px; /* increased spacing between cards */
            margin-bottom: 26px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 28px; /* slightly more breathing room */
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 1.2em;
            color: #007bff;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #666;
            font-size: 0.95em;
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
        }

        .metric-value.temp {
            color: #ff6b6b;
        }

        .metric-value.humidity {
            color: #007bff;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-on {
            background: #51cf66;
            box-shadow: 0 0 10px #51cf66;
        }

        .status-off {
            background: #adb5bd;
        }

        .status-warning {
            background: #ffd43b;
            box-shadow: 0 0 10px #ffd43b;
        }

        .status-error {
            background: #ff6b6b;
            box-shadow: 0 0 10px #ff6b6b;
        }

        .mode-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .mode-idle {
            background: #e9ecef;
            color: #495057;
        }

        .mode-evaporative {
            background: #cce5ff;
            color: #007bff;
        }

        .mode-chiller {
            background: #e3f2fd;
            color: #004085;
        }

        .mode-dehumidify {
            background: #fff3bf;
            color: #e67700;
        }

        .mode-emergency {
            background: #ffe0e0;
            color: #c92a2a;
        }

        .chart-container {
            grid-column: 1 / -1;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 18px; /* space above charts */
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #51cf66;
            color: white;
        }

        .btn-success:hover {
            background: #40c057;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn-danger:hover {
            background: #fa5252;
        }

        .btn-secondary {
            background: #adb5bd;
            color: white;
        }

        .btn-secondary:hover {
            background: #868e96;
        }

        select {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
        }

        .toggle-switch {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #adb5bd;
            border-radius: 13px;
            cursor: pointer;
            transition: 0.3s;
        }

        .switch.active {
            background: #51cf66;
        }

        .switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: 0.3s;
        }

        .switch.active::after {
            left: 27px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-info {
            background: #d0ebff;
            color: #1971c2;
            border-left: 4px solid #1971c2;
        }

        .alert-warning {
            background: #fff3bf;
            color: #e67700;
            border-left: 4px solid #e67700;
        }

        .alert-error {
            background: #ffe0e0;
            color: #c92a2a;
            border-left: 4px solid #c92a2a;
        }

        .timestamp {
            color: #868e96;
            font-size: 0.85em;
            margin-top: 10px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üå°Ô∏è Climate Control Dashboard</h1>
            <p class="subtitle">Mango Storage System - Optimal: 50-54¬∞F (10-12.2¬∞C), 85-90% RH</p>
        </header>

        <div id="alert" class="alert"></div>

        <div class="grid">
            <!-- Sensor Readings Card -->
            <div class="card">
                <div class="card-title">üìä Current Conditions</div>
                <div class="metric">
                    <span class="metric-label">Temperature</span>
                    <span class="metric-value temp" id="temperature">--¬∞C</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Humidity</span>
                    <span class="metric-value humidity" id="humidity">--%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Status</span>
                    <span id="connection-status">
                        <span class="status-indicator status-off"></span>
                        Connecting...
                    </span>
                </div>
                <div class="timestamp" id="last-update">Last update: --</div>
            </div>

            <!-- Control Mode Card -->
            <div class="card">
                <div class="card-title">üéØ Control System</div>
                <div class="metric">
                    <span class="metric-label">Operating Mode</span>
                    <span class="mode-badge mode-idle" id="mode">IDLE</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Target Temp</span>
                    <span class="metric-value" id="target-temp">5.0¬∞C</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Target Humidity</span>
                    <span class="metric-value" id="target-humidity">90.0%</span>
                </div>
            </div>

            <!-- Actuator Status Card -->
            <div class="card">
                <div class="card-title">‚öôÔ∏è Actuator Status</div>
                <div class="metric">
                    <span class="metric-label">
                        <span class="status-indicator status-off" id="pump-indicator"></span>
                        Water Pump
                    </span>
                    <span id="pump-state">OFF</span>
                </div>
                <div class="metric">
                    <span class="metric-label">
                        <span class="status-indicator status-off" id="chiller-indicator"></span>
                        Chiller
                    </span>
                    <span id="chiller-state">OFF</span>
                </div>
                <div class="metric">
                    <span class="metric-label">
                        <span class="status-indicator status-off" id="dehumidifier-indicator"></span>
                        Dehumidifier
                    </span>
                    <span id="dehumidifier-state">OFF</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Water Level</span>
                    <span id="water-level">
                        <span class="status-indicator status-on"></span>
                        OK
                    </span>
                </div>
            </div>
        </div>

        <!-- Controls Card -->
        <div class="card">
            <div class="card-title">üéÆ Controls</div>
            <div class="controls">
                <select id="preset-selector">
                    <option value="">Select Produce Type...</option>
                    <option value="mango" selected>Mango (50-54¬∞F, 85-90% RH)</option>
                    <option value="leafy_greens">Leafy Greens</option>
                    <option value="berries">Berries</option>
                    <option value="tomatoes">Tomatoes</option>
                    <option value="citrus">Citrus</option>
                </select>
                <button class="btn-primary" onclick="loadPreset()">Load Preset</button>
                <button class="btn-success" onclick="exportData()">Export Data</button>
                <button class="btn-secondary" onclick="toggleManualOverride()">
                    <span id="override-text">Enable Manual Override</span>
                </button>
            </div>
            <div id="manual-controls" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 2px solid #e9ecef;">
                <div class="controls">
                    <div class="toggle-switch">
                        <span>Pump:</span>
                        <div class="switch" id="pump-switch" onclick="toggleActuator('pump')"></div>
                    </div>
                    <div class="toggle-switch">
                        <span>Chiller:</span>
                        <div class="switch" id="chiller-switch" onclick="toggleActuator('chiller')"></div>
                    </div>
                    <div class="toggle-switch">
                        <span>Dehumidifier:</span>
                        <div class="switch" id="dehumidifier-switch" onclick="toggleActuator('dehumidifier')"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="chart-container">
            <div class="card-title">üìà Historical Data (24 hours)</div>
            <div id="temperature-chart"></div>
        </div>

        <div class="chart-container">
            <div id="humidity-chart"></div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO
        const socket = io();
        let manualOverride = false;
        let manualStates = { pump: false, chiller: false, dehumidifier: false };

        // Connection handlers
        socket.on('connect', () => {
            updateConnectionStatus(true);
            requestUpdate();
        });

        socket.on('disconnect', () => {
            updateConnectionStatus(false);
        });

        socket.on('update', (data) => {
            updateDisplay(data);
        });

        socket.on('error', (error) => {
            showAlert('Error: ' + error.message, 'error');
        });

        // Update connection status
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            if (connected) {
                statusEl.innerHTML = '<span class="status-indicator status-on"></span>Connected';
            } else {
                statusEl.innerHTML = '<span class="status-indicator status-error"></span>Disconnected';
            }
        }

        // Request data update
        function requestUpdate() {
            socket.emit('request_update');
        }

        // Update display with new data
        function updateDisplay(data) {
            // Update sensor readings
            if (data.temperature !== null) {
                document.getElementById('temperature').textContent = data.temperature.toFixed(1) + '¬∞C';
            }
            if (data.humidity !== null) {
                document.getElementById('humidity').textContent = data.humidity.toFixed(1) + '%';
            }

            // Update control info
            if (data.control) {
                const mode = data.control.mode || 'idle';
                const modeEl = document.getElementById('mode');
                modeEl.textContent = mode.toUpperCase();
                modeEl.className = 'mode-badge mode-' + mode;

                if (data.control.targets) {
                    document.getElementById('target-temp').textContent = data.control.targets.temperature.toFixed(1) + '¬∞C';
                    document.getElementById('target-humidity').textContent = data.control.targets.humidity.toFixed(1) + '%';
                }
            }

            // Update actuator states
            if (data.actuators) {
                updateActuatorIndicator('pump', data.actuators.pump);
                updateActuatorIndicator('chiller', data.actuators.chiller);
                updateActuatorIndicator('dehumidifier', data.actuators.dehumidifier);

                const waterLevelEl = document.getElementById('water-level');
                if (data.actuators.water_level_ok) {
                    waterLevelEl.innerHTML = '<span class="status-indicator status-on"></span>OK';
                } else {
                    waterLevelEl.innerHTML = '<span class="status-indicator status-error"></span>LOW';
                }
            }

            // Update manual override state
            if (data.manual_override !== undefined) {
                manualOverride = data.manual_override;
            }

            // Update timestamp
            const now = new Date();
            document.getElementById('last-update').textContent = 'Last update: ' + now.toLocaleTimeString();
        }

        // Update actuator indicator
        function updateActuatorIndicator(name, state) {
            const indicator = document.getElementById(name + '-indicator');
            const stateEl = document.getElementById(name + '-state');
            
            if (state === 'ON') {
                indicator.className = 'status-indicator status-on';
                stateEl.textContent = 'ON';
            } else if (state === 'FAULT') {
                indicator.className = 'status-indicator status-error';
                stateEl.textContent = 'FAULT';
            } else {
                indicator.className = 'status-indicator status-off';
                stateEl.textContent = 'OFF';
            }
        }

        // Load produce preset
        function loadPreset() {
            const preset = document.getElementById('preset-selector').value;
            if (!preset) {
                showAlert('Please select a produce type', 'warning');
                return;
            }

            fetch('/api/preset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ preset: preset })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Loaded preset: ' + preset, 'info');
                    requestUpdate();
                } else {
                    showAlert('Error: ' + data.error, 'error');
                }
            })
            .catch(error => showAlert('Error: ' + error, 'error'));
        }

        // Export data
        function exportData() {
            fetch('/api/export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hours: 24 })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Data exported: ' + data.filepath, 'info');
                } else {
                    showAlert('Error: ' + data.error, 'error');
                }
            })
            .catch(error => showAlert('Error: ' + error, 'error'));
        }

        // Toggle manual override
        function toggleManualOverride() {
            manualOverride = !manualOverride;
            
            fetch('/api/manual_override', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: manualOverride })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('override-text').textContent = 
                        manualOverride ? 'Disable Manual Override' : 'Enable Manual Override';
                    document.getElementById('manual-controls').style.display = 
                        manualOverride ? 'block' : 'none';
                    showAlert(manualOverride ? 'Manual override enabled' : 'Manual override disabled', 'info');
                } else {
                    showAlert('Error: ' + data.error, 'error');
                }
            })
            .catch(error => showAlert('Error: ' + error, 'error'));
        }

        // Toggle actuator in manual mode
        function toggleActuator(name) {
            if (!manualOverride) return;
            
            manualStates[name] = !manualStates[name];
            
            const switchEl = document.getElementById(name + '-switch');
            switchEl.classList.toggle('active');
            
            const data = { enabled: true };
            data[name] = manualStates[name];
            
            fetch('/api/manual_override', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .catch(error => showAlert('Error: ' + error, 'error'));
        }

        // Show alert
        function showAlert(message, type) {
            const alertEl = document.getElementById('alert');
            alertEl.textContent = message;
            alertEl.className = 'alert alert-' + type + ' show';
            setTimeout(() => {
                alertEl.classList.remove('show');
            }, 5000);
        }

        // Load and display charts (with fake-data fallback)
        function loadCharts() {
            fetch('/api/history?hours=24')
            .then(response => response.json())
            .then(data => {
                try {
                    // If the history endpoint returns empty arrays, render synthetic data
                    const hasData = data && Array.isArray(data.timestamps) && data.timestamps.length > 0;
                    if (!hasData) {
                        renderFakeCharts();
                        return;
                    }

                    // Temperature chart
                    const tempTrace = {
                        x: data.timestamps,
                        y: data.temperatures,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Temperature',
                        line: { color: '#ff6b6b', width: 2 }
                    };

                    const tempLayout = {
                        title: 'Temperature Over Time',
                        xaxis: { title: 'Time' },
                        yaxis: { title: 'Temperature (¬∞C)' },
                        margin: { t: 50, r: 50, b: 50, l: 50 }
                    };

                    Plotly.newPlot('temperature-chart', [tempTrace], tempLayout, { responsive: true });

                    // Humidity chart
                    const humidityTrace = {
                        x: data.timestamps,
                        y: data.humidities,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Humidity',
                        line: { color: '#4ecdc4', width: 2 }
                    };

                    const humidityLayout = {
                        title: 'Humidity Over Time',
                        xaxis: { title: 'Time' },
                        yaxis: { title: 'Humidity (%)' },
                        margin: { t: 50, r: 50, b: 50, l: 50 }
                    };

                    Plotly.newPlot('humidity-chart', [humidityTrace], humidityLayout, { responsive: true });
                } catch (err) {
                    console.error('Error rendering charts:', err);
                    renderFakeCharts();
                }
            })
            .catch(error => {
                console.error('Error loading charts:', error);
                renderFakeCharts();
            });
        }

        // Render synthetic charts when no real history is available
        function renderFakeCharts() {
            try {
                const points = 60; // 60 points = last 60 minutes roughly
                const now = new Date();
                const timestamps = [];
                const temperatures = [];
                const humidities = [];

                // Generate a gentle sinusoidal/linear variation around reasonable baselines
                const baseTemp = 22.0; // reasonable baseline if no data
                const baseHumidity = 55.0;

                // Use a smoothed random-walk with a slow sinusoidal diurnal component
                let tempVal = baseTemp + (Math.random() - 0.5) * 0.6;
                let humVal = baseHumidity + (Math.random() - 0.5) * 1.2;
                const tempVolatility = 0.12; // how noisy the walk is
                const humVolatility = 0.25;

                for (let i = points - 1; i >= 0; i--) {
                    const t = new Date(now.getTime() - i * 60 * 1000);
                    timestamps.push(t.toLocaleTimeString());

                    // slow diurnal-like oscillation (period ~ 12-24 points)
                    const diurnalFactor = Math.sin(i / 10) * 0.8;

                    // random-walk step
                    tempVal += (Math.random() - 0.5) * tempVolatility + diurnalFactor * 0.02;
                    humVal += (Math.random() - 0.5) * humVolatility - diurnalFactor * 0.04; // slightly anti-correlated

                    // small mean-reversion to baseline
                    tempVal += (baseTemp - tempVal) * 0.01;
                    humVal += (baseHumidity - humVal) * 0.02;

                    temperatures.push(parseFloat(tempVal.toFixed(2)));
                    humidities.push(parseFloat(humVal.toFixed(2)));
                }

                const tempTrace = {
                    x: timestamps,
                    y: temperatures,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Temperature (sim)',
                    line: { color: '#ff6b6b', width: 2, shape: 'spline', smoothing: 1.2 }
                };

                const tempLayout = {
                    title: 'Temperature (simulated)',
                    xaxis: { title: 'Time' },
                    yaxis: { title: 'Temperature (¬∞C)' },
                    margin: { t: 50, r: 50, b: 50, l: 50 }
                };

                Plotly.newPlot('temperature-chart', [tempTrace], tempLayout, { responsive: true });

                const humidityTrace = {
                    x: timestamps,
                    y: humidities,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Humidity (sim)',
                    line: { color: '#4ecdc4', width: 2, shape: 'spline', smoothing: 1.2 }
                };

                const humidityLayout = {
                    title: 'Humidity (simulated)',
                    xaxis: { title: 'Time' },
                    yaxis: { title: 'Humidity (%)' },
                    margin: { t: 50, r: 50, b: 50, l: 50 }
                };

                Plotly.newPlot('humidity-chart', [humidityTrace], humidityLayout, { responsive: true });
            } catch (err) {
                // As a last resort, show a simple textual placeholder
                console.error('Failed to render fake charts:', err);
                const tEl = document.getElementById('temperature-chart');
                const hEl = document.getElementById('humidity-chart');
                if (tEl) tEl.innerHTML = '<div style="padding:20px;color:#666">No chart available</div>';
                if (hEl) hEl.innerHTML = '<div style="padding:20px;color:#666">No chart available</div>';
            }
        }

        // Auto-refresh
        setInterval(requestUpdate, 2000);  // Request update every 2 seconds
        setInterval(loadCharts, 60000);    // Reload charts every minute

        // Initial load
        loadCharts();
    </script>
</body>
</html>

